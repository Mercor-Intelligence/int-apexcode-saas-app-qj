// Prisma Schema for BioLink v2
// Supports SQLite for local dev and PostgreSQL for production

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  passwordHash    String
  handle          String    @unique
  handleLower     String    @unique // For case-insensitive lookups
  
  // Profile info
  displayName     String?
  bioTitle        String?   @db.VarChar(60)
  bioDescription  String?   @db.VarChar(150)
  avatarUrl       String?
  category        String?
  
  // Appearance settings
  theme           String    @default("dark")
  buttonStyle     String    @default("rounded")
  fontFamily      String    @default("Inter")
  backgroundColor String?
  backgroundType  String    @default("gradient") // solid, gradient, image
  
  // Account settings
  planTier        String    @default("free") // free, premium
  emailVerified   Boolean   @default(false)
  isActive        Boolean   @default(true)
  deletedAt       DateTime?
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  links           Link[]
  socialIcons     SocialIcon[]
  analyticsEvents AnalyticsEvent[]
  
  @@index([handleLower])
  @@index([email])
}

model Link {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Link content
  url           String?
  title         String
  thumbnailUrl  String?
  
  // Link type and position
  type          LinkType  @default(CLASSIC)
  position      Int       @default(0)
  
  // Visibility and scheduling
  isActive      Boolean   @default(true)
  isDeleted     Boolean   @default(false)
  deletedAt     DateTime?
  
  // Scheduling (nullable = always visible)
  scheduledStart DateTime?
  scheduledEnd   DateTime?
  
  // Extended settings (JSON)
  settings      String?   @db.Text // JSON: gating, animation, etc.
  
  // Analytics
  clickCount    Int       @default(0)
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  analyticsEvents AnalyticsEvent[]
  
  @@index([userId])
  @@index([userId, isActive])
}

model SocialIcon {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  platform  String   // instagram, twitter, tiktok, youtube, email, etc.
  url       String
  position  Int      @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

model AnalyticsEvent {
  id          String      @id @default(uuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  linkId      String?
  link        Link?       @relation(fields: [linkId], references: [id], onDelete: SetNull)
  
  eventType   EventType
  referrer    String?
  referrerCategory String? // direct, social, search, other
  countryCode String?
  city        String?
  device      String?     // mobile, desktop, tablet
  userAgent   String?
  ipHash      String?     // Hashed IP for deduplication
  
  createdAt   DateTime    @default(now())
  
  @@index([userId])
  @@index([userId, eventType])
  @@index([linkId])
  @@index([createdAt])
}

enum LinkType {
  CLASSIC
  HEADER
  MUSIC
  VIDEO
  COMMERCE
}

enum EventType {
  PAGE_VIEW
  LINK_CLICK
}


